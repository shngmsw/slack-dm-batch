# Slack一括DM送信システム タスクリスト

## 1. 基盤構築タスク

### 1.1 プロジェクト初期設定
- [x] ディレクトリ構造の作成 (app/, static/, templates/, logs/)
- [x] requirements.txt の作成と依存関係定義
- [x] 基本設定ファイル (config.py) の作成
- [x] README.md の作成

### 1.2 データモデル定義
- [x] Pydantic モデルの作成 (models.py)
  - User, MessageTemplate, SendRequest, SendResult モデル
  - バリデーション機能の実装

## 2. バックエンド実装タスク

### 2.1 Slack API クライアント
- [x] SlackClient クラスの作成 (slack_client.py)
  - トークン認証機能
  - DM送信機能 (send_dm)
  - ユーザー情報取得機能 (get_user_by_name, get_user_info)
  - トークン検証機能 (validate_token)
  - レート制限遵守とリトライ機能
  - 詳細なエラーメッセージとトラブルシューティング

### 2.2 メッセージ処理機能
- [x] MessageProcessor クラスの作成 (message_processor.py)
  - テンプレート変数抽出機能 (extract_variables)
  - テンプレートレンダリング機能 (render_template)
  - テンプレート検証機能 (validate_template)

### 2.3 ユーザー解析機能
- [x] UserParser クラスの作成 (user_parser.py)
  - メンション解析機能 (@Misawa.もせ 形式対応)
  - CSV解析機能 (parse_csv)
  - JSON解析機能 (parse_json)
  - ユーザー名からユーザー情報解決機能 (resolve_users)

### 2.4 FastAPI アプリケーション
- [x] メインアプリケーション作成 (main.py)
  - FastAPI インスタンス作成と設定
  - 静的ファイル配信設定
  - CORS設定
  - エラーハンドラー設定

- [x] API エンドポイント実装
  - [x] POST /api/parse-mentions (メンション解析)
  - [x] POST /api/preview (メッセージプレビュー)
  - [x] POST /api/import-variables (変数データCSVインポート)
  - [x] POST /api/send-messages (メッセージ送信)
  - [x] GET /api/status/{job_id} (送信状況確認)
  - [x] GET / (Web UI 配信)

### 2.5 バックグラウンド処理
- [x] 非同期送信処理の実装
  - ジョブ管理機能
  - 進捗状況管理
  - 送信結果収集

### 2.6 ログ機能
- [x] ログ設定の実装
  - ファイルローテーション設定
  - レベル別ログ出力
  - 送信結果詳細記録

## 3. フロントエンド実装タスク

### 3.1 HTML テンプレート
- [x] index.html の作成
  - 5段階のステップ形式UI
  - レスポンシブデザイン
  - アクセシビリティ対応
  - ステップ間ナビゲーション（戻るボタン）
  - Slackトークン取得方法の説明

### 3.2 CSS スタイル
- [x] style.css の作成
  - モダンでクリーンなデザイン
  - フォーム要素のスタイリング
  - 進捗表示のアニメーション
  - エラー・成功状態の表示
  - エラー詳細表示のスタイリング

### 3.3 JavaScript 機能
- [x] app.js の作成
  - [x] 基本機能
    - API通信用の関数群
    - エラーハンドリング機能
    - フォームバリデーション
  
  - [x] Step 1: 認証機能
    - トークン入力・保存機能
    - トークン検証機能
  
  - [x] Step 2: 送信対象設定機能
    - メンション貼り付け・解析機能
    - ファイルドラッグ&ドロップ機能
    - ユーザーリスト表示・編集機能
  
  - [x] Step 3: メッセージ作成機能
    - テンプレート入力機能
    - 変数検出・表示機能
    - リアルタイムプレビュー機能
  
  - [x] Step 4: 変数設定機能
    - ユーザーごと変数入力フィールド動的生成
    - CSV変数データインポート機能
    - 一括設定機能
  
  - [x] Step 5: 送信実行機能
    - 最終プレビュー表示機能
    - 送信開始機能
    - リアルタイム進捗表示機能
    - 送信結果一覧表示機能
    - 送信再実行機能
    - アプリケーションリセット機能

## 4. セキュリティ・品質タスク

### 4.1 セキュリティ実装
- [x] 入力サニタイゼーション
- [x] CSRF対策
- [x] トークンの安全な管理
- [x] ファイルアップロード制限

### 4.2 エラーハンドリング
- [x] 各種エラー状況の適切な処理
- [x] ユーザーフレンドリーなエラーメッセージ
- [x] 詳細ログ出力
- [x] Slack API エラーの詳細解説とトラブルシューティング

### 4.3 テスト
- [x] 手動テスト実行（動作確認完了）
- [ ] 単体テストの作成
  - SlackClient のテスト
  - MessageProcessor のテスト
  - UserParser のテスト
- [ ] 統合テストの作成

## 5. 最終調整・ドキュメント

### 5.1 パフォーマンス最適化
- [x] メモリ使用量の最適化
- [x] 非同期処理の最適化
- [x] レスポンス時間の改善

### 5.2 ドキュメント作成
- [x] README.md の充実
  - インストール手順
  - 設定方法
  - 使用方法
  - トラブルシューティング
- [x] API ドキュメント (FastAPI 自動生成)

### 5.3 デプロイ準備
- [x] 環境設定の整理
- [x] 依存関係の最終確認
- [x] 起動スクリプトの作成

## 優先順位と進行方針

### フェーズ1: 最小機能版 (MVP) ✅ **完了**
1. ✅ 基盤構築 (1.1, 1.2)
2. ✅ Slack API基本機能 (2.1 の基本部分)
3. ✅ 簡単な送信機能 (2.4 の基本部分)
4. ✅ 基本的なWeb UI (3.1, 3.2 の基本部分)

### フェーズ2: 主要機能実装 ✅ **完了**
1. ✅ メンション解析機能 (2.3)
2. ✅ テンプレート機能 (2.2)
3. ✅ Web UI の充実 (3.3)

### フェーズ3: 高度機能・品質向上 ✅ **完了**
1. ✅ 変数設定機能
2. ✅ セキュリティ・エラーハンドリング (4.1, 4.2)
3. ✅ UI改善（ナビゲーション・再実行機能）
4. ✅ エラーメッセージの大幅改善
5. ⏳ テスト・最適化 (4.3, 5.1) - 手動テスト完了、単体テスト未実装

### フェーズ4: 完成・ドキュメント ✅ **完了**
1. ✅ 最終調整 (5.2, 5.3)
2. ✅ 動作テスト・デバッグ完了
3. ✅ ドキュメント完成

### 現在のステータス: **🎉 基本機能完成・動作確認済み**
- 全ての基本機能が実装済み
- Slack API権限エラー対応済み
- UI/UXが大幅改善済み
- 実用レベルで動作中 (http://localhost:8000)

## 6. 拡張機能タスク（将来実装予定）

### 6.1 メッセージテンプレート管理
- [ ] テンプレート保存機能
  - よく使うテンプレートの保存
  - テンプレートの名前付け・分類
  - テンプレート一覧表示・選択機能
- [ ] テンプレートエクスポート/インポート
  - JSON形式でのテンプレート共有
  - チーム間でのテンプレート共有機能

### 6.2 送信履歴管理
- [ ] 送信履歴の保存・表示
  - 送信日時、対象者、メッセージ内容の記録
  - 送信結果（成功/失敗）の履歴
- [ ] 送信履歴の検索・フィルタ機能
  - 日付範囲での絞り込み
  - ユーザー名での検索
  - 送信結果での絞り込み
- [ ] 履歴からの再送信機能
  - 過去の送信設定をベースにした再送信
  - 送信対象の編集・追加

### 6.3 スケジュール送信
- [ ] 送信予約機能
  - 日時指定での送信スケジューリング
  - 定期送信（日次、週次、月次）
- [ ] スケジュール管理UI
  - 予約済み送信の一覧表示
  - スケジュールの編集・キャンセル機能
- [ ] バックグラウンドスケジューラー
  - Celery または APScheduler を使用
  - スケジュールされた送信の自動実行

### 6.4 データ管理・分析
- [ ] 送信結果のCSVエクスポート
  - 詳細な送信結果をCSV形式で出力
  - 成功率やエラー統計の出力
- [ ] 送信統計・ダッシュボード
  - 送信成功率の推移グラフ
  - よく発生するエラーの分析
  - ユーザー別送信統計
- [ ] データベース統合
  - SQLite または PostgreSQL での永続化
  - データの長期保存・管理

### 6.5 ユーザビリティ向上
- [ ] ダークモード対応
  - ライト/ダークテーマの切り替え
  - ユーザー設定の保存
- [ ] キーボードショートカット
  - 各ステップ間の移動
  - よく使う機能への素早いアクセス
- [ ] ユーザー設定の永続化
  - よく使う設定の保存
  - デフォルトトークンの暗号化保存

### 6.6 高度な送信機能
- [ ] 送信速度の調整機能
  - カスタマイズ可能なレート制限
  - バースト送信とスロー送信の選択
- [ ] 条件分岐送信
  - ユーザー属性に基づく条件分岐
  - 異なるメッセージテンプレートの自動選択
- [ ] 添付ファイル送信
  - 画像やドキュメントの添付
  - ファイルタイプの制限・管理

### 6.7 セキュリティ強化
- [ ] ユーザー認証システム
  - ログイン機能
  - 複数ユーザーでの利用
- [ ] 監査ログ
  - 全ての操作のログ記録
  - セキュリティイベントの監視
- [ ] トークン管理の改善
  - トークンの暗号化保存
  - トークンの自動更新機能

### 6.8 API機能拡張
- [ ] Webhook連携
  - 外部システムからのトリガー送信
  - 送信結果の外部システムへの通知
- [ ] REST API公開
  - プログラマティックな送信制御
  - 他システムとの統合
- [ ] Slack Bot統合
  - Slackコマンドからの送信実行
  - Bot経由でのインタラクティブな操作

### 6.9 多言語・国際化対応
- [ ] 多言語UI対応
  - 英語、日本語、その他の言語サポート
  - 言語設定の切り替え機能
- [ ] タイムゾーン対応
  - ユーザーのタイムゾーン設定
  - スケジュール送信での正確な時間管理

### 6.10 パフォーマンス・スケーラビリティ
- [ ] 大量送信の最適化
  - バッチサイズの最適化
  - メモリ使用量の削減
- [ ] キャッシュ機能
  - ユーザー情報のキャッシュ
  - API呼び出しの削減
- [ ] 負荷分散対応
  - 複数プロセスでの送信処理
  - Redis を使用したジョブキュー

## 実行ルール
- 各タスクは段階的に実行し、一度に複数を並行しない
- エラーは必ず解決してから次のタスクに進む
- 完了したタスクは [x] でマークする
- 各フェーズ完了時に動作確認を実施する
- 拡張機能は基本機能の安定化後に検討・実装する